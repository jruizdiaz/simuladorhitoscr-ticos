<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Crisis E-commerce | Proyecto Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; }
        
        /* Animaciones */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .crisis-active { animation: pulse-red 2s infinite; border-color: #ef4444 !important; }
        
        @keyframes slide-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-up { animation: slide-up 0.4s ease-out forwards; }

        /* Estilos de Tarjeta */
        .card { background: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        
        /* Formulario Canvas Toggle */
        .canvas-toggle {
            cursor: pointer; background-color: #f1f5f9; border-radius: 0.5rem; padding: 1rem;
            transition: background-color 0.2s;
        }
        .canvas-toggle:hover { background-color: #e2e8f0; }
        .canvas-content { 
            max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out; 
            border-top: 1px solid #e2e8f0; margin-top: -1px;
        }
        .canvas-content.open { max-height: 1000px; padding-top: 1rem; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <span class="text-2xl mr-2">üöÄ</span>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">Simulador E-commerce</h1>
                        <p class="text-xs text-gray-500">Plataforma de Entrenamiento Situacional</p>
                    </div>
                </div>
                <div class="flex items-center">
                    <span class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800 flex items-center">
                        <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span> Sistema Online
                    </span>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">

        <div class="mb-8 text-center sm:text-left">
            <h2 class="text-3xl font-bold text-gray-800">Laboratorio de Crisis</h2>
            <p class="mt-2 text-gray-600 max-w-3xl">
                Complete el **Digital Strategy Canvas** y elija su modelo de negocio para ejecutar la simulaci√≥n y recibir un Hito Cr√≠tico.
            </p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <div class="lg:col-span-4 space-y-6">
                
                <div class="card p-6 border-t-4 border-indigo-500">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <span class="mr-2">‚öôÔ∏è</span> Configuraci√≥n de la empresa.
                    </h3>
                    
                    <div class="space-y-4">
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Tutor/Profesor</label>
                            <input type="text" id="tutor-name" placeholder="Ej: Pablo Escaf" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Identificador de Grupo</label>
                            <input type="text" id="group-id" placeholder="Ej: GRUPO-A4" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Modelo de Negocio</label>
                            <select id="business-model" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border bg-white">
                                <option value="retail">üõçÔ∏è Retail / Masivo</option>
                                <option value="b2b">üè≠ B2B Industrial</option>
                                <option value="services">üíº Servicios / SaaS</option>
                                <option value="dnvb">üì± DNVB / Nicho</option>
                            </select>
                        </div>
                        
                        <div class="border border-gray-300 rounded-lg">
                            <div class="canvas-toggle flex justify-between items-center" onclick="toggleCanvasForm()">
                                <h4 class="text-sm font-bold text-gray-700 flex items-center">
                                    <span id="canvas-status-icon" class="mr-2 text-red-500">üî¥</span> DIGITAL STRATEGY CANVAS
                                </h4>
                                <span id="canvas-arrow" class="text-lg transform rotate-0 transition-transform duration-300">‚ñº</span>
                            </div>
                            
                            <div id="canvas-form-content" class="canvas-content p-4">
                                <p class="text-xs text-gray-500 mb-3">Rellene al menos un detalle por bloque.</p>
                                <div class="space-y-3">
                                    <label class="block text-xs font-semibold text-gray-700">1. Audiencia Objetivo (Buyer Persona)</label>
                                    <textarea id="canvas-audience" class="w-full p-2 border border-gray-300 rounded text-sm" rows="2" placeholder="Describir p√∫blico primario y Pain Points."></textarea>
                                    
                                    <label class="block text-xs font-semibold text-gray-700">2. Propuesta de Valor Digital (DVP)</label>
                                    <textarea id="canvas-value" class="w-full p-2 border border-gray-300 rounded text-sm" rows="2" placeholder="Valor √∫nico que ofrece tu canal digital."></textarea>
                                    
                                    <label class="block text-xs font-semibold text-gray-700">3. Canales Clave</label>
                                    <input type="text" id="canvas-channels" class="w-full p-2 border border-gray-300 rounded text-sm" placeholder="Ej: Meta Ads, SEO, E-mail Marketing">
                                    
                                    <label class="block text-xs font-semibold text-gray-700">4. M√©tricas de √âxito (KPIs)</label>
                                    <input type="text" id="canvas-metrics" class="w-full p-2 border border-gray-300 rounded text-sm" placeholder="Ej: LTV, CAC, Tasa de Conversi√≥n">
                                    
                                    <button onclick="saveCanvasData()" id="save-canvas-btn" class="w-full py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-semibold rounded mt-3">
                                        Guardar Canvas y Habilitar Simulaci√≥n
                                    </button>
                                </div>
                            </div>
                        </div>

                        <button id="simulate-btn" onclick="runSimulation()" class="w-full py-3 px-4 bg-gray-800 hover:bg-black text-white rounded-lg font-bold shadow-md transition-all transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            ‚ö° EJECUTAR SIMULACI√ìN
                        </button>
                    </div>
                </div>

                <div class="card p-6 bg-blue-50 border border-blue-100">
                    <h4 class="text-sm font-bold text-blue-800 mb-2">Ticket de Incidente Asignado</h4>
                    <p id="assigned-ticket" class="text-xl font-mono text-blue-900 break-all">TICKET-0000</p>
                    <p class="text-xs text-blue-600 mt-2">Usar este ID en el reporte.</p>
                </div>

            </div>

            <div class="lg:col-span-8">
                <div class="card h-full min-h-[400px] flex flex-col relative overflow-hidden border border-gray-200" id="output-container">
                    
                    <div class="bg-gray-100 border-b border-gray-200 p-3 flex justify-between items-center">
                        <span class="text-xs font-mono text-gray-500">TERMINAL DE SUCESOS ‚Ä¢ v2.4.0</span>
                        <div class="flex space-x-1">
                            <div class="w-3 h-3 rounded-full bg-red-400"></div>
                            <div class="w-3 h-3 rounded-full bg-yellow-400"></div>
                            <div class="w-3 h-3 rounded-full bg-green-400"></div>
                        </div>
                    </div>

                    <div class="flex-grow p-8 flex items-center justify-center bg-white relative">
                        
                        <div id="state-idle" class="text-center opacity-100 transition-opacity duration-300">
                            <div class="text-6xl mb-4">üñ•Ô∏è</div>
                            <h3 class="text-xl font-bold text-gray-400">Sistema en Espera</h3>
                            <p class="text-gray-400 mt-2">Complete el Canvas y configure el modelo para iniciar.</p>
                        </div>

                        <div id="state-loading" class="hidden text-center w-full max-w-md">
                            <div class="mx-auto w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mb-4"></div>
                            <h3 class="text-lg font-bold text-indigo-700 animate-pulse">Analizando Vulnerabilidades...</h3>
                            <div class="mt-4 bg-gray-100 p-3 rounded font-mono text-xs text-left text-gray-600 h-24 overflow-hidden border border-gray-200">
                                <p>> Leyendo estructura de Canvas...</p>
                                <p>> Escaneando: <span id="scan-keyword" class="font-bold text-indigo-600">...</span></p>
                                <p>> Cruzando datos con API de mercado...</p>
                                <p>> Calculando probabilidad de fallo...</p>
                            </div>
                        </div>

                        <div id="state-result" class="hidden w-full max-w-3xl animate-slide-up">
                            
                            <div class="border-l-8 border-red-500 pl-6 py-2 mb-6">
                                <div class="flex justify-between items-start">
                                    <span class="inline-block px-3 py-1 bg-red-100 text-red-700 text-xs font-bold rounded mb-2 tracking-wide uppercase">Incidente Cr√≠tico Detectado</span>
                                    <span class="text-sm text-gray-400 font-mono" id="result-code">ERR-204</span>
                                </div>
                                <h2 id="result-title" class="text-3xl font-extrabold text-gray-900 leading-tight mb-2">
                                    </h2>
                                <p id="result-desc" class="text-lg text-gray-700 leading-relaxed">
                                    </p>
                            </div>

                            <div class="bg-gray-50 rounded-lg border border-gray-200 p-5 shadow-inner mb-6">
                                <h4 class="text-sm font-bold text-gray-900 mb-2 flex items-center">
                                    <span class="bg-indigo-600 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs mr-2">!</span>
                                    ACCI√ìN REQUERIDA INMEDIATA
                                </h4>
                                <p id="result-action" class="text-sm font-medium text-indigo-700">
                                    </p>
                            </div>
                            
                            <div class="bg-red-50 rounded-lg border border-red-200 p-5">
                                <h4 class="text-sm font-bold text-red-700 mb-3 flex items-center">
                                    <span class="text-xl mr-2">üìß</span>
                                    EMAIL DE REPORTE AL TUTOR (PLANTILLA)
                                </h4>
                                <pre id="email-output" class="text-xs bg-red-100 text-red-900 p-3 rounded overflow-x-auto whitespace-pre-wrap"></pre>
                                <button onclick="copyEmailToClipboard()" class="mt-3 w-full py-2 bg-red-500 hover:bg-red-600 text-white text-sm font-semibold rounded">
                                    Copiar Email al Portapapeles
                                </button>
                            </div>

                            <div class="mt-8 flex justify-end">
                                <button onclick="resetSimulation()" class="text-sm text-gray-500 hover:text-gray-800 underline">
                                    Reiniciar Simulaci√≥n
                                </button>
                            </div>

                        </div>

                    </div>
                    
                    <div class="absolute inset-0 pointer-events-none opacity-5" 
                         style="background-image: radial-gradient(#4f46e5 1px, transparent 1px); background-size: 20px 20px;">
                    </div>

                </div>
            </div>
        </div>
        
        <section class="mt-8 grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-white p-3 rounded-lg shadow-sm text-center border border-gray-100">
                <div class="text-xl mb-1">üõçÔ∏è</div>
                <div class="text-xs font-bold text-gray-600">RETAIL</div>
            </div>
            <div class="bg-white p-3 rounded-lg shadow-sm text-center border border-gray-100">
                <div class="text-xl mb-1">üè≠</div>
                <div class="text-xs font-bold text-gray-600">B2B</div>
            </div>
            <div class="bg-white p-3 rounded-lg shadow-sm text-center border border-gray-100">
                <div class="text-xl mb-1">üíº</div>
                <div class="text-xs font-bold text-gray-600">SERVICIOS</div>
            </div>
            <div class="bg-white p-3 rounded-lg shadow-sm text-center border border-gray-100">
                <div class="text-xl mb-1">üì±</div>
                <div class="text-xs font-bold text-gray-600">DNVB</div>
            </div>
        </section>

    </main>

    <footer class="bg-white border-t border-gray-200 mt-auto py-6">
        <div class="max-w-7xl mx-auto px-4 text-center text-xs text-gray-400">
            Simulador E-Commerce v1.2 ‚Ä¢ Basado en Modelos de Negocio Reales - Dise√±ado por Mg.Lic.Juan Ru√≠z D√≠az para TUCEMD - UTN FRBA - 2025
        </div>
    </footer>

    <script>
        // --- DATA BASE: 20 CRITICAL SITUATIONS ---
        const incidentsDB = {
            'retail': [
                { title: "El 'Error de Precio' Viral", desc: "Un error en el CSV puso Smart TVs a $5.00. Se vendieron 200 unidades en 15 minutos y las redes arden exigiendo la entrega.", action: "Decidir entre cancelar (crisis PR) o entregar (p√©rdida masiva). Redactar comunicado oficial." },
                { title: "Colapso en Hot Sale", desc: "El operador log√≠stico informa demora de 7 d√≠as h√°biles para env√≠os '24hs' por saturaci√≥n. Tienes 500 etiquetas impresas.", action: "Configurar reglas de email marketing autom√°tico para contener la ansiedad y ofrecer compensaci√≥n." },
                { title: "Suspensi√≥n en Marketplace", desc: "Mercado Libre/Amazon paus√≥ tu cuenta principal. La tasa de reclamos lleg√≥ al 4% (l√≠mite 3%).", action: "Elaborar Plan de Acci√≥n y Apelaci√≥n detallando soluci√≥n de ra√≠z a los reclamos." },
                { title: "Quiebre de Stock (Overselling)", desc: "Fallo de sincronizaci√≥n. Vendiste 50 unidades de un producto sin stock. El proveedor repone en 30 d√≠as.", action: "Contactar clientes uno a uno, ofrecer devoluci√≥n inmediata + 20% giftcard." },
                { title: "Fraude de 'Carding' Masivo", desc: "La pasarela alerta sobre 30 transacciones aprobadas sospechosas con el mismo IP y distintas tarjetas.", action: "Analizar patrones, detener despachos f√≠sicos y activar 3D Secure." }
            ],
            'b2b': [
                { title: "Concurso de Acreedores", desc: "Tu cliente estrella (40% de facturaci√≥n) entr√≥ en quiebra. Facturas impagas a 90 d√≠as y pedido en producci√≥n.", action: "Detener producci√≥n inmediata y consultar con legales recuperaci√≥n de deuda." },
                { title: "Traba en Importaciones", desc: "Licencias de importaci√≥n para un repuesto cr√≠tico bloqueadas por el gobierno por 60 d√≠as.", action: "Comunicar a clientes industriales y buscar proveedores locales alternativos aunque sean m√°s caros." },
                { title: "Error en Especificaci√≥n", desc: "El lote de 1,000 piezas entregado tiene una tolerancia t√©rmica menor a la prometida. Riesgo de seguridad.", action: "Ejecutar 'Recall' inmediato y asumir costos log√≠sticos inversos totales." },
                { title: "Intento de Soborno", desc: "El gerente de compras de una gran empresa sugiere una 'comisi√≥n personal' del 5% para ganar la licitaci√≥n.", action: "Rechazar oferta por √©tica y reportar internamente o retirar la oferta." },
                { title: "Ruptura de Cadena de Fr√≠o", desc: "Transporte subcontratado no respet√≥ protocolos. El cliente rechaza la carga completa en puerta.", action: "Activar seguro de carga y enviar reposici√≥n urgente v√≠a transporte premium." }
            ],
            'services': [
                { title: "Ca√≠da de Servidores (Downtime)", desc: "Tu SaaS est√° ca√≠do hace 4 horas. Usuarios furiosos en Twitter. El SLA garantizaba 99.9%.", action: "Gesti√≥n de crisis en RRSS y calcular descuento/cr√©dito en factura por contrato." },
                { title: "Fuga de Cerebros", desc: "Tu Lead Dev y Senior Account Manager renuncian el mismo d√≠a llev√°ndose know-how clave.", action: "Plan de contingencia RRHH y revisi√≥n de cl√°usulas de confidencialidad." },
                { title: "Filtraci√≥n de Datos (Breach)", desc: "Hacker publica base de datos de tus usuarios. Correos y contrase√±as expuestos.", action: "Notificaci√≥n legal obligatoria (GDPR), forzar reseteo de contrase√±as y auditor√≠a." },
                { title: "Cliente 'Scope Creep'", desc: "Cliente exige entregables fuera de presupuesto amenazando con no pagar el saldo final.", action: "Defender el contrato original diplom√°ticamente o negociar adenda comercial." },
                { title: "Plagio de Propiedad Intelectual", desc: "Tu curso o c√≥digo se revende ilegalmente en otra web a mitad de precio.", action: "Enviar carta documento 'Cease and Desist' y denunciar links (DMCA)." }
            ],
            'dnvb': [
                { title: "Bloqueo Cuenta Publicitaria", desc: "Meta inhabilit√≥ tu Business Manager por error. El tr√°fico cay√≥ un 80% de golpe.", action: "Pivotar presupuesto a Influencers/Email y gestionar apelaci√≥n con soporte." },
                { title: "Crisis de 'Greenwashing'", desc: "Tiktoker descubre que tus envases 'Sostenibles' no son reciclables. La comunidad se siente traicionada.", action: "Video de disculpa del CEO y plan p√∫blico de transici√≥n de materiales." },
                { title: "Unboxing Desastroso", desc: "Nuevo proveedor de cajas fall√≥. Clientes suben fotos de productos rotos y cajas aplastadas.", action: "Volver al packaging anterior y enviar 'Kits de disculpas' para recuperar LTV." },
                { title: "CAC Disparado", desc: "Entr√≥ un competidor chino (tipo Temu) y el costo por clic se triplic√≥. Margen negativo.", action: "Redefinir propuesta de valor (calidad vs precio) y enfocarse en retenci√≥n." },
                { title: "El Influencer 'T√≥xico'", desc: "Influencer contratado hace comentarios discriminatorios en vivo. Tu marca queda pegada.", action: "Rescindir contrato p√∫blicamente y donar el importe a una ONG afectada." }
            ]
        };

        const keywordsDB = {
            'retail': ['SKU', 'Checkout', 'Log√≠stica', 'Stock', 'Promo'],
            'b2b': ['Licitaci√≥n', 'Factura A', 'Proveedor', 'Norma ISO', 'Cr√©dito'],
            'services': ['SLA', 'Server', 'Token', 'Lead', 'Churn'],
            'dnvb': ['Meta Ads', 'Engagement', 'Packaging', 'Nicho', 'Story']
        };

        // Global variable to store Canvas data
        let canvasData = null;
        let currentTicket = "TICKET-0000";

        // --- TICKET GENERATION ---
        function generateTicketID(groupId) {
            const datePart = new Date().toISOString().slice(0, 10).replace(/-/g, ''); // YYYYMMDD
            const randomPart = Math.random().toString(36).substring(2, 6).toUpperCase();
            return `TICKET-${groupId.replace(/[^a-zA-Z0-9]/g, '')}-${datePart}-${randomPart}`;
        }

        // --- CANVAS FORM LOGIC ---
        function toggleCanvasForm() {
            const content = document.getElementById('canvas-form-content');
            const arrow = document.getElementById('canvas-arrow');
            
            content.classList.toggle('open');
            arrow.classList.toggle('rotate-180');
        }

        function saveCanvasData() {
            const audience = document.getElementById('canvas-audience').value.trim();
            const value = document.getElementById('canvas-value').value.trim();
            const channels = document.getElementById('canvas-channels').value.trim();
            const metrics = document.getElementById('canvas-metrics').value.trim();
            const tutorName = document.getElementById('tutor-name').value.trim();
            const groupId = document.getElementById('group-id').value.trim();

            if (!audience || !value || !channels || !metrics || !tutorName || !groupId) {
                alert("Por favor, complete todos los campos obligatorios del Canvas y la Configuraci√≥n (Tutor/Grupo) antes de guardar.");
                return;
            }

            canvasData = {
                audience,
                value,
                channels,
                metrics
            };
            
            // Generate and display unique ticket ID
            currentTicket = generateTicketID(groupId);
            document.getElementById('assigned-ticket').innerText = currentTicket;

            // Update UI status
            document.getElementById('simulate-btn').disabled = false;
            document.getElementById('canvas-status-icon').innerText = 'üü¢';
            document.getElementById('canvas-status-icon').classList.remove('text-red-500');
            document.getElementById('canvas-status-icon').classList.add('text-green-500');
            document.getElementById('save-canvas-btn').innerText = 'Canvas Guardado. ¬°Listo para simular!';
            document.getElementById('save-canvas-btn').classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            document.getElementById('save-canvas-btn').classList.add('bg-green-600', 'hover:bg-green-700');
            
            alert("Canvas guardado y simulaci√≥n habilitada.");
        }


        // --- SIMULATION LOGIC ---

        function runSimulation() {
            // 1. Get Values
            const model = document.getElementById('business-model').value;
            const tutorName = document.getElementById('tutor-name').value.trim();
            const groupId = document.getElementById('group-id').value.trim();
            
            // Final pre-check
            if (!tutorName || !groupId || !canvasData) {
                 alert("Complete el Canvas Estrat√©gico, Tutor y Grupo antes de iniciar la simulaci√≥n.");
                 return;
            }

            // 2. UI State: Loading
            document.getElementById('state-idle').classList.add('hidden');
            document.getElementById('state-result').classList.add('hidden');
            document.getElementById('output-container').classList.remove('crisis-active');
            document.getElementById('state-loading').classList.remove('hidden');
            
            // 3. Simulate Scanning (Visual Effect)
            let scanCount = 0;
            const scanInterval = setInterval(() => {
                const words = keywordsDB[model];
                document.getElementById('scan-keyword').innerText = words[scanCount % words.length];
                scanCount++;
            }, 250);

            // 4. Generate Result after Delay
            setTimeout(() => {
                clearInterval(scanInterval);
                generateCrisis(model, tutorName, groupId);
            }, 2500); // 2.5 seconds wait
        }

        function generateCrisis(model, tutorName, groupId) {
            // Get random incident from the specific model array
            const scenarios = incidentsDB[model];
            const incident = scenarios[Math.floor(Math.random() * scenarios.length)];
            const code = "ERR-" + Math.floor(Math.random() * 900 + 100);
            
            // Populate DOM
            document.getElementById('result-title').innerText = incident.title;
            document.getElementById('result-desc').innerText = incident.desc;
            document.getElementById('result-action').innerText = incident.action;
            document.getElementById('result-code').innerText = code;
            
            // Generate Email Template
            const emailBody = `Asunto: [URGENTE] INCIDENTE CR√çTICO DETECTADO | ${currentTicket}\n\nEstimado/a ${tutorName || 'Tutor'},\n\nMediante la presente, el Grupo ${groupId || 'sin asignar'} reporta la detecci√≥n del siguiente Incidente Cr√≠tico durante la simulaci√≥n de Estrategia Digital (${model.toUpperCase()}).\n\n--- CONTEXTO OPERACIONAL (Canvas) ---\nAudiencia Clave: ${canvasData.audience}\nPropuesta de Valor (DVP): ${canvasData.value}\nCanales Primarios: ${canvasData.channels}\nKPIs de √âxito: ${canvasData.metrics}\n\n--- DETALLES DEL INCIDENTE ---\n\nID de Ticket: ${currentTicket}\nModelo de Negocio: ${model.toUpperCase()}\nC√≥digo de Error: ${code}\n\nTITULO: ${incident.title}\nDESCRIPCI√ìN: ${incident.desc}\n\nACCI√ìN REQUERIDA INMEDIATA:\n${incident.action}\n\n--- FIN DEL REPORTE ---\n\nQuedamos a la espera de su respuesta para confirmar el Plan de Acci√≥n.\n\nAtentamente,\nEquipo de Crisis del Grupo ${groupId || 'sin asignar'}`;
            
            document.getElementById('email-output').innerText = emailBody;

            // Switch UI State
            document.getElementById('state-loading').classList.add('hidden');
            document.getElementById('state-result').classList.remove('hidden');
            
            // Add Alarm Effect
            document.getElementById('output-container').classList.add('crisis-active');
        }

        function resetSimulation() {
            // Reset UI States
            document.getElementById('state-result').classList.add('hidden');
            document.getElementById('output-container').classList.remove('crisis-active');
            document.getElementById('state-idle').classList.remove('hidden');
            
            // Reset Canvas Status
            canvasData = null;
            document.getElementById('simulate-btn').disabled = true;
            document.getElementById('canvas-status-icon').innerText = 'üî¥';
            document.getElementById('canvas-status-icon').classList.remove('text-green-500');
            document.getElementById('canvas-status-icon').classList.add('text-red-500');
            document.getElementById('save-canvas-btn').innerText = 'Guardar Canvas y Habilitar Simulaci√≥n';
            document.getElementById('save-canvas-btn').classList.remove('bg-green-600', 'hover:bg-green-700');
            document.getElementById('save-canvas-btn').classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            
            // Reset Ticket
            document.getElementById('assigned-ticket').innerText = "TICKET-0000";
            currentTicket = "TICKET-0000";
            document.getElementById('email-output').innerText = "";
        }

        function copyEmailToClipboard() {
            const emailText = document.getElementById('email-output').innerText;
            navigator.clipboard.writeText(emailText).then(() => {
                alert("¬°Email copiado al portapapeles! Ahora puede enviarlo al tutor.");
            }).catch(err => {
                console.error('Error al copiar: ', err);
                alert("Error al copiar. Por favor, seleccione el texto manualmente.");
            });
        }
        
        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
             // Ensure canvas is closed on load
             document.getElementById('canvas-form-content').classList.remove('open');
        });
    </script>
</body>
</html>