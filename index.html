<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Crisis E-commerce | Proyecto Final (v1.4.1 Depurado)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3ff6; color: #1f2937; }
        
        /* Animaciones */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .crisis-active { animation: pulse-red 2s infinite; border-color: #ef4444 !important; }
        
        @keyframes slide-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-up { animation: slide-up 0.4s ease-out forwards; }

        /* Estilos de Tarjeta */
        .card { background: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        
        /* Formulario Canvas Toggle */
        .canvas-toggle {
            cursor: pointer; background-color: #f1f5f9; border-radius: 0.5rem; padding: 1rem;
            transition: background-color 0.2s;
        }
        .canvas-toggle:hover { background-color: #e2e8f0; }
        .canvas-content { 
            max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out; 
            border-top: 1px solid #e2e8f0; margin-top: -1px;
        }
        .canvas-content.open { max-height: 2500px; padding-top: 1rem; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <span class="text-2xl mr-2">üöÄ</span>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">Simulador E-commerce</h1>
                        <p class="text-xs text-gray-500">Plataforma de Entrenamiento Situacional</p>
                    </div>
                </div>
                <div class="flex items-center">
                    <span class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800 flex items-center">
                        <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span> Sistema Online
                    </span>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">

        <div class="mb-8 text-center sm:text-left">
            <h2 class="text-3xl font-bold text-gray-800">Laboratorio de Crisis</h2>
            <p class="mt-2 text-gray-600 max-w-3xl">
                Complete el **Digital Strategy Canvas** con m√©tricas de Mercado y Finanzas para simular con datos reales.
            </p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <div class="lg:col-span-4 space-y-6">
                
                <div class="card p-6 border-t-4 border-indigo-500">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <span class="mr-2">‚öôÔ∏è</span> Configuraci√≥n de Agencia
                    </h3>
                    
                    <div class="space-y-4">
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Tutor/Profesor <span class="text-red-500">*</span></label>
                            <input type="text" id="tutor-name" placeholder="Ej: Dra. Garc√≠a" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Identificador de Grupo <span class="text-red-500">*</span></label>
                            <input type="text" id="group-id" placeholder="Ej: GRUPO-A4" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Modelo de Negocio</label>
                            <select id="business-model" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border bg-white">
                                <option value="retail">üõçÔ∏è Retail / Masivo</option>
                                <option value="b2b">üè≠ B2B Industrial</option>
                                <option value="services">üíº Servicios / SaaS</option>
                                <option value="dnvb">üì± DNVB / Nicho</option>
                            </select>
                        </div>
                        
                        <div class="border border-gray-300 rounded-lg">
                            <div class="canvas-toggle flex justify-between items-center" onclick="toggleCanvasForm()">
                                <h4 class="text-sm font-bold text-gray-700 flex items-center">
                                    <span id="canvas-status-icon" class="mr-2 text-red-500">üî¥</span> DIGITAL STRATEGY CANVAS (COMPLETO)
                                </h4>
                                <span id="canvas-arrow" class="text-lg transform rotate-0 transition-transform duration-300">‚ñº</span>
                            </div>
                            
                            <div id="canvas-form-content" class="canvas-content p-4">
                                <p class="text-xs text-gray-500 mb-3 font-semibold text-indigo-700">M√≥dulos Estrat√©gicos & Financieros</p>
                                <div class="space-y-4">
                                    
                                    <div class="p-3 bg-gray-50 rounded-md border border-gray-200 space-y-2">
                                        <label class="block text-xs font-bold text-indigo-700">M√ìDULO ESTRAT√âGICO</label>
                                        <label class="block text-xs font-semibold text-gray-700">1. Audiencia Objetivo (Buyer Persona) <span class="text-red-500">*</span></label>
                                        <textarea id="canvas-audience" class="w-full p-2 border border-gray-300 rounded text-sm" rows="1" placeholder="P√∫blico primario y Pain Points."></textarea>
                                        
                                        <label class="block text-xs font-semibold text-gray-700">2. Propuesta de Valor Digital (DVP) <span class="text-red-500">*</span></label>
                                        <textarea id="canvas-value" class="w-full p-2 border border-gray-300 rounded text-sm" rows="1" placeholder="Valor √∫nico del canal digital."></textarea>
                                        
                                        <label class="block text-xs font-semibold text-gray-700">3. Canales Clave</label>
                                        <input type="text" id="canvas-channels" class="w-full p-2 border border-gray-300 rounded text-sm" placeholder="Ej: Meta Ads, SEO, E-mail Marketing">
                                        
                                        <label class="block text-xs font-semibold text-gray-700">4. M√©tricas de √âxito (KPIs)</label>
                                        <input type="text" id="canvas-metrics" class="w-full p-2 border border-gray-300 rounded text-sm" placeholder="Ej: LTV, CAC, Tasa de Conversi√≥n">
                                    </div>
                                    
                                    <div class="p-3 bg-gray-50 rounded-md border border-gray-200 space-y-2">
                                        <label class="block text-xs font-bold text-indigo-700">M√ìDULO DE MERCADO</label>
                                        <label class="block text-xs font-semibold text-gray-700">5. Dimensi√≥n TAM SAM SOM ($)</label>
                                        <input type="text" id="canvas-tam" class="w-full p-2 border border-gray-300 rounded text-sm" placeholder="Ej: TAM: 10M, SAM: 5M, SOM: 1M">
                                        
                                        <label class="block text-xs font-semibold text-gray-700">6. Principales Competidores</label>
                                        <input type="text" id="canvas-competitors" class="w-full p-2 border border-gray-300 rounded text-sm" placeholder="Ej: Amazon, TiendaX, MarcaB">
                                        
                                        <label class="block text-xs font-semibold text-gray-700">7. PA√çS y A√ëOS Proyectados</label>
                                        <input type="text" id="canvas-projections" class="w-full p-2 border border-gray-300 rounded text-sm" placeholder="Ej: M√©xico - 3 A√±os">
                                    </div>

                                    <div class="p-3 bg-gray-50 rounded-md border border-gray-200 space-y-2">
                                        <label class="block text-xs font-bold text-indigo-700">M√ìDULO FINANCIERO (Valores Anuales Proyectados)</label>
                                        
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="block text-xs font-semibold text-gray-700">8. Presupuesto Total Anual ($) <span class="text-red-500">*</span></label>
                                                <input type="number" id="canvas-budget" class="w-full p-2 border border-gray-300 rounded text-sm" placeholder="Ej: 50000" min="0">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-semibold text-gray-700">9. Margen Bruto (%) <span class="text-red-500">*</span></label>
                                                <input type="number" id="canvas-gross-margin" class="w-full p-2 border border-gray-300 rounded text-sm" placeholder="Ej: 45" min="0" max="100">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-semibold text-gray-700">10. Margen Neto (%)</label>
                                                <input type="number" id="canvas-net-margin" class="w-full p-2 border border-gray-300 rounded text-sm" placeholder="Ej: 10" min="0" max="100">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-semibold text-gray-700">11. Punto de Equilibrio ($/Unid)</label>
                                                <input type="text" id="canvas-break-even" class="w-full p-2 border border-gray-300 rounded text-sm" placeholder="Ej: $2000 o 500 Unid">
                                            </div>
                                        </div>

                                        <label class="block text-xs font-semibold text-gray-700">12. Ingresos Proyectados ($) <span class="text-red-500">*</span></label>
                                        <input type="number" id="canvas-revenue" class="w-full p-2 border border-gray-300 rounded text-sm" placeholder="Ej: 200000" min="0">

                                        <label class="block text-xs font-semibold text-gray-700">13. Costos Totales ($)</label>
                                        <input type="number" id="canvas-costs" class="w-full p-2 border border-gray-300 rounded text-sm" placeholder="Ej: 150000" min="0">

                                        <label class="block text-xs font-semibold text-gray-700">14. ROI Esperado (%)</label>
                                        <input type="number" id="canvas-roi" class="w-full p-2 border border-gray-300 rounded text-sm" placeholder="Ej: 33" min="0">
                                    </div>
                                    
                                    <button onclick="saveCanvasData()" id="save-canvas-btn" class="w-full py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-semibold rounded mt-3">
                                        Guardar Canvas y Habilitar Simulaci√≥n
                                    </button>
                                </div>
                            </div>
                        </div>

                        <button id="simulate-btn" onclick="runSimulation()" class="w-full py-3 px-4 bg-gray-800 hover:bg-black text-white rounded-lg font-bold shadow-md transition-all transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            ‚ö° EJECUTAR SIMULACI√ìN
                        </button>
                    </div>
                </div>

                <div class="card p-6 bg-blue-50 border border-blue-100">
                    <h4 class="text-sm font-bold text-blue-800 mb-2">Ticket de Incidente Asignado</h4>
                    <p id="assigned-ticket" class="text-xl font-mono text-blue-900 break-all">TICKET-0000</p>
                    <p class="text-xs text-blue-600 mt-2">Usar este ID en el reporte.</p>
                </div>

            </div>

            <div class="lg:col-span-8">
                <div class="card h-full min-h-[400px] flex flex-col relative overflow-hidden border border-gray-200" id="output-container">
                    
                    <div class="bg-gray-100 border-b border-gray-200 p-3 flex justify-between items-center">
                        <span class="text-xs font-mono text-gray-500">TERMINAL DE SUCESOS ‚Ä¢ v2.4.0</span>
                        <div class="flex space-x-1">
                            <div class="w-3 h-3 rounded-full bg-red-400"></div>
                            <div class="w-3 h-3 rounded-full bg-yellow-400"></div>
                            <div class="w-3 h-3 rounded-full bg-green-400"></div>
                        </div>
                    </div>

                    <div class="flex-grow p-8 flex items-center justify-center bg-white relative">
                        
                        <div id="state-idle" class="text-center opacity-100 transition-opacity duration-300">
                            <div class="text-6xl mb-4">üñ•Ô∏è</div>
                            <h3 class="text-xl font-bold text-gray-400">Sistema en Espera</h3>
                            <p class="text-gray-400 mt-2">Complete el Canvas Estrat√©gico y Financiero para iniciar.</p>
                        </div>

                        <div id="state-loading" class="hidden text-center w-full max-w-md">
                            <div class="mx-auto w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mb-4"></div>
                            <h3 class="text-lg font-bold text-indigo-700 animate-pulse">Analizando Vulnerabilidades...</h3>
                            <div class="mt-4 bg-gray-100 p-3 rounded font-mono text-xs text-left text-gray-600 h-24 overflow-hidden border border-gray-200">
                                <p>> Leyendo estructura de Canvas...</p>
                                <p>> Escaneando: <span id="scan-keyword" class="font-bold text-indigo-600">...</span></p>
                                <p>> Cruzando datos con API de mercado...</p>
                                <p>> Calculando probabilidad de fallo...</p>
                            </div>
                        </div>

                        <div id="state-result" class="hidden w-full max-w-3xl animate-slide-up">
                            
                            <div class="border-l-8 border-red-500 pl-6 py-2 mb-6">
                                <div class="flex justify-between items-start">
                                    <span class="inline-block px-3 py-1 bg-red-100 text-red-700 text-xs font-bold rounded mb-2 tracking-wide uppercase">Incidente Cr√≠tico Detectado</span>
                                    <span class="text-sm text-gray-400 font-mono" id="result-code">ERR-204</span>
                                </div>
                                <h2 id="result-title" class="text-3xl font-extrabold text-gray-900 leading-tight mb-2">
                                    </h2>
                                <p id="result-desc" class="text-lg text-gray-700 leading-relaxed">
                                    </p>
                            </div>

                            <div class="bg-red-50 rounded-lg border border-red-200 p-5 shadow-inner mb-6">
                                <h4 class="text-sm font-bold text-red-700 mb-2 flex items-center">
                                    <span class="text-xl mr-2">üö®</span>
                                    IMPACTO Y PLAZO DE RESOLUCI√ìN
                                </h4>
                                <p id="result-action" class="text-base font-medium text-red-700 leading-relaxed">
                                    </p>
                            </div>
                            
                            <div class="bg-gray-100 rounded-lg border border-gray-200 p-5">
                                <h4 class="text-sm font-bold text-gray-700 mb-3 flex items-center">
                                    <span class="text-xl mr-2">üìß</span>
                                    REPORTE DE INCIDENTE AL TUTOR
                                </h4>
                                <pre id="email-output" class="text-xs bg-white text-gray-900 p-3 rounded overflow-x-auto whitespace-pre-wrap border border-gray-300"></pre>
                                <button onclick="copyEmailToClipboard()" class="mt-3 w-full py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-semibold rounded">
                                    Copiar Email al Portapapeles (Enviar a Tutor)
                                </button>
                            </div>

                            <div class="mt-8 flex justify-end">
                                <button onclick="resetSimulation()" class="text-sm text-gray-500 hover:text-gray-800 underline">
                                    Reiniciar Simulaci√≥n
                                </button>
                            </div>

                        </div>

                    </div>
                    
                    <div class="absolute inset-0 pointer-events-none opacity-5" 
                         style="background-image: radial-gradient(#4f46e5 1px, transparent 1px); background-size: 20px 20px;">
                    </div>

                </div>
            </div>
        </div>
        
        <section class="mt-8 grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-white p-3 rounded-lg shadow-sm text-center border border-gray-100">
                <div class="text-xl mb-1">üõçÔ∏è</div>
                <div class="text-xs font-bold text-gray-600">RETAIL</div>
            </div>
            <div class="bg-white p-3 rounded-lg shadow-sm text-center border border-gray-100">
                <div class="text-xl mb-1">üè≠</div>
                <div class="text-xs font-bold text-gray-600">B2B</div>
            </div>
            <div class="bg-white p-3 rounded-lg shadow-sm text-center border border-gray-100">
                <div class="text-xl mb-1">üíº</div>
                <div class="text-xs font-bold text-gray-600">SERVICIOS</div>
            </div>
            <div class="bg-white p-3 rounded-lg shadow-sm text-center border border-gray-100">
                <div class="text-xl mb-1">üì±</div>
                <div class="text-xs font-bold text-gray-600">DNVB</div>
            </div>
        </section>

    </main>

    <footer class="bg-white border-t border-gray-200 mt-auto py-6">
        <div class="max-w-7xl mx-auto px-4 text-center text-xs text-gray-400">
            Simulador de Crisis para TUCEMD ‚Ä¢ Creado por: Mg.Lic.Juan Ru√≠z D√≠az - 2025
        </div>
    </footer>

    <script>
        // --- DATA BASE: 20 CRITICAL SITUATIONS (Mantenemos la misma DB con interpolaci√≥n) ---
        const incidentsDB = {
            'retail': [
                { 
                    title: "Colapso Log√≠stico y Viralizaci√≥n Negativa", 
                    desc: "La campa√±a de lanzamiento super√≥ las proyecciones (Ingresos $${revenue}) pero la Log√≠stica subcontratada colaps√≥. La m√©trica de 'Tiempos de Entrega' se triplic√≥, y en redes sociales los usuarios (Audiencia: ${audience}) est√°n usando el hashtag #FraudeEntrega. Esto pone en riesgo la Propuesta de Valor (DVP: ${value}) basada en la inmediatez.", 
                    points: [
                        "Comunicaci√≥n y Manejo de Crisis: Detener la viralizaci√≥n negativa y restaurar la confianza del cliente.",
                        "Operaciones y Log√≠stica: Buscar soluciones inmediatas para los pedidos varados y reducir el tiempo de despacho.",
                        "Finanzas y Presupuesto: Evaluar el costo de compensaciones/devoluciones contra el Margen Neto (${netMargin}%)."
                    ], 
                    timeframe: "48 horas." 
                },
                { 
                    title: "Brecha de Seguridad en Checkout y P√©rdida de Confianza", 
                    desc: "La pasarela de pago sufri√≥ un ataque. Se extrajeron datos de 500 clientes. Aunque el problema est√° contenido, la prensa local informa que el sitio es 'inseguro'. Esto afecta directamente el KPI de Tasa de Conversi√≥n (KPIs: ${metrics}). Los competidores (${competitors}) est√°n utilizando esto en sus campa√±as.", 
                    points: [
                        "Legal y Cumplimiento: Manejar la notificaci√≥n legal de fuga de datos (GDPR/Ley local).",
                        "Marketing y Confianza: Crear una estrategia de comunicaci√≥n para recuperar la credibilidad del cliente afectado y potencial.",
                        "Tecnolog√≠a: Implementar nuevas medidas de seguridad (ej. 3D Secure, auditor√≠a) en un plazo de ${projections}."
                    ], 
                    timeframe: "72 horas." 
                },
                { 
                    title: "Ca√≠da de Margen por Guerra de Precios", 
                    desc: "Un competidor directo (${competitors}) baj√≥ sus precios un 15% en tu categor√≠a principal, oblig√°ndote a igualar para no perder ventas. Esto reduce tu Margen Bruto al l√≠mite y pone en riesgo el Punto de Equilibrio (${breakEven}) y el ROI Esperado (${roi}%).", 
                    points: [
                        "Estrategia de Precios: Determinar si la bajada es sostenible o si es mejor enfocar el marketing en la Propuesta de Valor (DVP: ${value}).",
                        "Finanzas: Revisar la estructura de Costos Totales (${costs}) para buscar eficiencias y proteger el Margen Neto (${netMargin}%).",
                        "Marketing de Contenido: Fortalecer los Canales Clave (${channels}) con mensajes de valor que justifiquen el precio original."
                    ], 
                    timeframe: "1 semana." 
                },
                // A√±adir m√°s incidentes para tener variedad
                { 
                    title: "Regulaci√≥n Ilegal de Canales Clave", 
                    desc: "El gobierno del Pa√≠s (${projections}) implement√≥ nuevas regulaciones que proh√≠ben la segmentaci√≥n por intereses en Meta Ads (Canales Clave: ${channels}), eliminando la mitad de la efectividad de tu Presupuesto Total Anual ($${budget}).", 
                    points: [
                        "Estrategia de Medios: Pivotar la inversi√≥n publicitaria a canales no afectados (ej. SEO, e-mail marketing).",
                        "Legal: Determinar el impacto a largo plazo de la nueva regulaci√≥n en el sector (${tam} TAM) y c√≥mo adaptarte legalmente.",
                        "Audiencia: Reestructurar la captaci√≥n de Audiencia Objetivo (${audience}) mediante contenido org√°nico y alianzas."
                    ], 
                    timeframe: "3 d√≠as para el plan de contingencia." 
                }
            ],
            // Los dem√°s modelos B2B, SERVICES, DNVB tambi√©n deber√≠an ser ampliados con placeholders como ejemplo.
            'b2b': [
                { 
                    title: "Conflicto con Cliente Clave y Desviaci√≥n de Presupuesto", 
                    desc: "Un cliente que representa el 30% de los Ingresos Proyectados ($${revenue}) se niega a pagar la √∫ltima factura, argumentando que el servicio no cumpli√≥ la Norma ISO esperada. La demora afecta gravemente el Punto de Equilibrio (${breakEven}). El Presupuesto Total Anual (${budget}) ya est√° comprometido.",
                    points: [
                        "Negociaci√≥n y Relaciones Comerciales: Estrategia de mediaci√≥n con el cliente para asegurar el pago parcial o total.",
                        "Finanzas y Flujo de Caja: Identificar recortes de Costos Totales (${costs}) para cubrir el hueco de liquidez.",
                        "Operaciones y Calidad: Auditar internamente el proceso que llev√≥ a la falla de la Norma ISO para evitar futuros incidentes."
                    ], 
                    timeframe: "1 semana (5 d√≠as h√°biles)." 
                },
                // ...
            ],
            'services': [
                { 
                    title: "Fuga de Talento Cr√≠tico y Ca√≠da del SLA", 
                    desc: "Tu Lead Developer renunci√≥ para irse con un competidor (${competitors}), llev√°ndose consigo c√≥digo sensible. Adem√°s, el servidor principal cay√≥ durante 6 horas, incumpliendo el SLA prometido. Esto impacta el Margen Neto (${netMargin}%) debido a las compensaciones que se deben realizar.",
                    points: [
                        "Recursos Humanos y Legal: Acciones legales por incumplimiento de cl√°usulas de confidencialidad.",
                        "T√©cnico y Operaciones: Implementar una soluci√≥n de redundancia de servidores a corto plazo y restaurar el servicio.",
                        "Atenci√≥n al Cliente: Definir la pol√≠tica de compensaci√≥n a los clientes por la ca√≠da y restablecer la confianza en la Plataforma."
                    ], 
                    timeframe: "3 d√≠as." 
                },
                // ...
            ],
            'dnvb': [
                { 
                    title: "Ataque Reputacional por Competencia y Disparo de CAC", 
                    desc: "Tu principal competidor (${competitors}) lanz√≥ una campa√±a masiva de publicidad 'comparativa' en tu pa√≠s (${projections}), atacando tu 'Greenwashing' (si aplica) o DVP (${value}). Esto ha triplicado el Costo de Adquisici√≥n de Cliente (CAC) y pone en riesgo el ROI Esperado (${roi}%).",
                    points: [
                        "Relaciones P√∫blicas y Marca: Estrategia de comunicaci√≥n p√∫blica para contrarrestar la campa√±a negativa sin caer en confrontaci√≥n.",
                        "Marketing Digital: Optimizar urgentemente la inversi√≥n en Canales Clave (${channels}) para bajar el CAC.",
                        "Producto y Operaciones: Revisar si el reclamo del competidor tiene base (ej. ¬øEl DVP es s√≥lido?) y realizar ajustes internos."
                    ], 
                    timeframe: "48 horas (Cr√≠ticas) + 2 semanas (Estrategia)." 
                },
                // ...
            ]
        };

        const keywordsDB = {
            'retail': ['SKU', 'Checkout', 'Log√≠stica', 'Stock', 'Promo'],
            'b2b': ['Licitaci√≥n', 'Factura A', 'Proveedor', 'Norma ISO', 'Cr√©dito'],
            'services': ['SLA', 'Server', 'Token', 'Lead', 'Churn'],
            'dnvb': ['Meta Ads', 'Engagement', 'Packaging', 'Nicho', 'Story']
        };

        let canvasData = null;
        let currentTicket = "TICKET-0000";

        // --- TICKET GENERATION ---
        function generateTicketID(groupId) {
            const datePart = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            const randomPart = Math.random().toString(36).substring(2, 6).toUpperCase();
            return `TICKET-${groupId.replace(/[^a-zA-Z0-9]/g, '')}-${datePart}-${randomPart}`;
        }

        // --- CANVAS FORM LOGIC ---
        function toggleCanvasForm() {
            const content = document.getElementById('canvas-form-content');
            const arrow = document.getElementById('canvas-arrow');
            content.classList.toggle('open');
            arrow.classList.toggle('rotate-180');
        }

        /**
         * Funci√≥n DEPURADA: Recoge y valida los datos del Canvas.
         */
        function saveCanvasData() {
            // 1. Definici√≥n de IDs y Recolecci√≥n de Datos
            const inputIds = [
                'audience', 'value', 'channels', 'metrics', 'tam', 'competitors', 'projections',
                'budget', 'gross-margin', 'net-margin', 'break-even', 'revenue', 'costs', 'roi'
            ];

            const data = {};
            inputIds.forEach(key => {
                const element = document.getElementById(`canvas-${key}`);
                // Sanitize key name for JSON (e.g., 'gross-margin' -> 'grossMargin')
                const cleanKey = key.replace(/-([a-z])/g, (g) => g[1].toUpperCase());
                data[cleanKey] = element ? element.value.trim() : '';
            });

            const tutorName = document.getElementById('tutor-name').value.trim();
            const groupId = document.getElementById('group-id').value.trim();

            // 2. Validaci√≥n de Campos Cr√≠ticos (*)
            if (!tutorName) { alert("¬°Alerta! Debe ingresar el Nombre del Tutor/Profesor."); return; }
            if (!groupId) { alert("¬°Alerta! Debe ingresar el Identificador de Grupo."); return; }
            if (!data.audience) { alert("¬°Alerta! Debe ingresar la Audiencia Objetivo (Buyer Persona)."); return; }
            if (!data.value) { alert("¬°Alerta! Debe ingresar la Propuesta de Valor Digital (DVP)."); return; }
            
            // Validaci√≥n Financiera Cr√≠tica (Conversi√≥n a n√∫mero para validaci√≥n)
            if (!data.budget || isNaN(Number(data.budget))) { alert("¬°Alerta! El Presupuesto Total Anual debe ser un n√∫mero v√°lido."); return; }
            if (!data.grossMargin || isNaN(Number(data.grossMargin))) { alert("¬°Alerta! El Margen Bruto (%) debe ser un n√∫mero v√°lido."); return; }
            if (!data.revenue || isNaN(Number(data.revenue))) { alert("¬°Alerta! Los Ingresos Proyectados deben ser un n√∫mero v√°lido."); return; }


            // 3. Almacenar Datos Globalmente
            canvasData = data;
            
            // 4. Generar Ticket y Actualizar UI
            currentTicket = generateTicketID(groupId);
            document.getElementById('assigned-ticket').innerText = currentTicket;

            document.getElementById('simulate-btn').disabled = false;
            document.getElementById('canvas-status-icon').innerText = 'üü¢';
            document.getElementById('canvas-status-icon').classList.remove('text-red-500');
            document.getElementById('canvas-status-icon').classList.add('text-green-500');
            document.getElementById('save-canvas-btn').innerText = 'Canvas Guardado. ¬°Listo para simular!';
            document.getElementById('save-canvas-btn').classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            document.getElementById('save-canvas-btn').classList.add('bg-green-600', 'hover:bg-green-700');
            
            alert("Canvas guardado y simulaci√≥n habilitada. Ahora presione 'EJECUTAR SIMULACI√ìN'.");
        }


        // --- SIMULATION LOGIC ---

        function runSimulation() {
            const tutorName = document.getElementById('tutor-name').value.trim();
            const groupId = document.getElementById('group-id').value.trim();
            
            if (!tutorName || !groupId || !canvasData) {
                 // Esto no deber√≠a pasar si saveCanvasData funcion√≥, pero es un buen doble check.
                 alert("ERROR: La configuraci√≥n o el Canvas no est√°n completos. Por favor, guarde el Canvas.");
                 return;
            }

            // 1. UI State: Loading
            document.getElementById('state-idle').classList.add('hidden');
            document.getElementById('state-result').classList.add('hidden');
            document.getElementById('output-container').classList.remove('crisis-active');
            document.getElementById('state-loading').classList.remove('hidden');
            
            // 2. Simulate Scanning
            const model = document.getElementById('business-model').value;
            let scanCount = 0;
            const scanInterval = setInterval(() => {
                const words = keywordsDB[model];
                document.getElementById('scan-keyword').innerText = words[scanCount % words.length];
                scanCount++;
            }, 250);

            // 3. Generate Result after Delay
            setTimeout(() => {
                clearInterval(scanInterval);
                generateCrisis(model, tutorName, groupId);
            }, 2500);
        }

        function generateCrisis(model, tutorName, groupId) {
            // 1. Get Incident and Code
            const scenarios = incidentsDB[model];
            const incidentTemplate = scenarios[Math.floor(Math.random() * scenarios.length)];
            const code = "ERR-" + Math.floor(Math.random() * 900 + 100);
            
            // 2. Hydrate Incident details (Replace placeholders in desc)
            let incidentDesc = incidentTemplate.desc;
            
            // Interpolaci√≥n de variables del Canvas. Ahora los placeholders son ${key}
            for (const key in canvasData) {
                const placeholder = new RegExp('\\$\\{' + key + '\\}', 'g');
                incidentDesc = incidentDesc.replace(placeholder, canvasData[key] || 'N/A');
            }

            // 3. Populate DOM
            document.getElementById('result-title').innerText = incidentTemplate.title;
            document.getElementById('result-desc').innerText = incidentDesc;
            
            // 4. Set Timeframe for Resolution
            document.getElementById('result-action').innerText = 
                `PLAZO M√ÅXIMO DE RESPUESTA Y PLAN DE ACCI√ìN REQUERIDO: ${incidentTemplate.timeframe}. La falta de respuesta en este periodo agravar√° la crisis hasta el punto de la inoperatividad.`;
            document.getElementById('result-code').innerText = code;
            
            // 5. Format financial data for email
            const currencyFormatter = new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 });
            
            // Usamos las keys limpias de canvasData
            const budgetFormatted = canvasData.budget ? currencyFormatter.format(Number(canvasData.budget)) : 'N/A';
            const revenueFormatted = canvasData.revenue ? currencyFormatter.format(Number(canvasData.revenue)) : 'N/A';
            const costsFormatted = canvasData.costs ? currencyFormatter.format(Number(canvasData.costs)) : 'N/A';
            
            // 6. Detailed Action Points (The 3 points)
            const actionPoints = incidentTemplate.points.map(p => `‚Ä¢ ${p}`).join('\n');

            // 7. Generate Email Template
            const emailBody = 
`Asunto: [ALERTA CR√çTICA] INCIDENTE ${code} ASIGNADO | ${currentTicket}
Generado por: ${tutorName || 'Tutor no especificado'}

Estimado/a ${tutorName || 'Tutor'},

El Grupo ${groupId || 'sin asignar'} ha sido informado sobre la detecci√≥n y asignaci√≥n del siguiente Incidente Cr√≠tico.

--- CONTEXTO ESTRAT√âGICO Y DE MERCADO ---
Audiencia Clave: ${canvasData.audience || 'N/A'}
Propuesta de Valor (DVP): ${canvasData.value || 'N/A'}
Canales Primarios: ${canvasData.channels || 'N/A'}
KPIs de √âxito: ${canvasData.metrics || 'N/A'}
Dimensi√≥n TAM/SAM/SOM: ${canvasData.tam || 'N/A'}
Competidores: ${canvasData.competitors || 'N/A'}

--- CONTEXTO FINANCIERO (Proyectado) ---
Presupuesto Total Anual: ${budgetFormatted}
Margen Bruto/Neto: ${canvasData.grossMargin || 'N/A'}% / ${canvasData.netMargin || 'N/A'}%
Ingresos Proyectados: ${revenueFormatted}

--- DETALLES DEL INCIDENTE ${code} ---

ID de Ticket: ${currentTicket}
Modelo de Negocio: ${model.toUpperCase()}

TITULO: ${incidentTemplate.title}
DESCRIPCI√ìN DETALLADA: ${incidentDesc}

--- PUNTOS CR√çTICOS A SOLUCIONAR ---
(El Plan de Acci√≥n del Grupo debe abordar estos tres frentes)
${actionPoints}

--- PLAZO PARA PRESENTAR PLAN ---
El tiempo m√°ximo para la resoluci√≥n es de ${incidentTemplate.timeframe}.

--- FIN DEL REPORTE ---
IMPORTANCIA DE RESOLVER LA CRISIS:
La r√°pida y efectiva gesti√≥n de esta crisis es fundamental para asegurar la continuidad operativa, proteger el ${canvasData.roi || 'ROI esperado'} y mantener la Propuesta de Valor frente a los ${canvasData.competitors || 'competidores'}. Un fallo en la gesti√≥n podr√≠a llevar a una p√©rdida permanente de cuota de mercado y un descenso irreparable en el Margen Neto.

Atentamente,
Equipo de Crisis del Grupo ${groupId || 'sin asignar'}`;
            
            document.getElementById('email-output').innerText = emailBody;

            // 8. Switch UI State
            document.getElementById('state-loading').classList.add('hidden');
            document.getElementById('state-result').classList.remove('hidden');
            document.getElementById('output-container').classList.add('crisis-active');
        }

        function resetSimulation() {
            // Reset UI States and Data
            document.getElementById('state-result').classList.add('hidden');
            document.getElementById('output-container').classList.remove('crisis-active');
            document.getElementById('state-idle').classList.remove('hidden');
            
            canvasData = null;
            document.getElementById('simulate-btn').disabled = true;
            document.getElementById('canvas-status-icon').innerText = 'üî¥';
            document.getElementById('canvas-status-icon').classList.remove('text-green-500');
            document.getElementById('canvas-status-icon').classList.add('text-red-500');
            document.getElementById('save-canvas-btn').innerText = 'Guardar Canvas y Habilitar Simulaci√≥n';
            document.getElementById('save-canvas-btn').classList.remove('bg-green-600', 'hover:bg-green-700');
            document.getElementById('save-canvas-btn').classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            
            document.getElementById('assigned-ticket').innerText = "TICKET-0000";
            currentTicket = "TICKET-0000";
            document.getElementById('email-output').innerText = "";
        }

        function copyEmailToClipboard() {
            const emailText = document.getElementById('email-output').innerText;
            navigator.clipboard.writeText(emailText).then(() => {
                alert("¬°Email copiado al portapapeles! Ahora puede enviarlo al tutor.");
            }).catch(err => {
                console.error('Error al copiar: ', err);
                alert("Error al copiar. Por favor, seleccione el texto manualmente.");
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
             document.getElementById('canvas-form-content').classList.remove('open');
        });
    </script>
</body>

</html>
